import './select.sass';
import { getUseInputPropsDefinition, useInput } from '../../../composables/input/useInput';
import { getEqPropsDefinition } from '../../../composables/shared';
import { DefaultThemePropsDefinition, useTheme } from '../../../composables/theme';
import { extractProp, isBoolean } from '../../../utils/helpers';
import { defineComponent, h, shallowRef } from 'vue';
export function getBSelectPropsDefinition(eq) {
    return {
        ...getEqPropsDefinition(eq),
        ...getUseInputPropsDefinition(),
        ...DefaultThemePropsDefinition,
        items: {
            type: Array,
            required: true
        },
        isMultiple: {
            type: Boolean,
            default: false
        },
        itemKey: {
            type: [String, Function]
        },
        itemText: {
            type: [String, Function],
            default: 'text'
        },
        itemValue: {
            type: [String, Function],
            default: 'value'
        },
        itemDisabled: {
            type: [String, Function],
            default: 'isDisabled'
        },
        displayCount: {
            type: [String, Number]
        }
    };
}
function getControlClasses(isExpanded, hasIcon) {
    return {
        'is-expanded': isExpanded,
        'has-icons-left': hasIcon
    };
}
function isMultiple(props, input) {
    return props.isMultiple || (props.isMultiple === undefined && Array.isArray(input.modelValue.value));
}
function isEmpty(val) {
    return val === null || val === undefined || (Array.isArray(val) && val.length === 0);
}
function getSelectClasses(props, input) {
    return [
        input.size.value,
        props.variant,
        {
            'is-fullwidth': input.isFullwidth.value,
            'is-loading': props.isLoading,
            'is-multiple': isMultiple(props, input),
            'is-rounded': props.isRounded,
            'is-empty': isEmpty(input.modelValue.value)
        }
    ];
}
function generatePlaceholder(props, context) {
    return h('option', {
        value: '',
        disabled: true,
        selected: true
    }, context.slots.placeholder ? context.slots.placeholder() : props.placeholder);
}
function getIsSelected(props, input) {
    return (val) => {
        const equals = props.eq.equals;
        const value = input.modelValue.value;
        if (value === null || value === undefined) {
            return false;
        }
        else if (isMultiple(props, input)) {
            return Array.isArray(value) ? value.some(v => equals(v, val)) : false;
        }
        else {
            return equals(val, value);
        }
    };
}
function generateOptions(props, context, input) {
    const isSelected = getIsSelected(props, input);
    return props.items.map((item, index) => {
        const isDisabled = extractProp(props.itemDisabled, item);
        return context.slots.option
            ? context.slots.option({ item, index })
            : h('option', {
                key: props.itemKey ? extractProp(props.itemKey, item) : String(index),
                value: extractProp(props.itemValue, item),
                disabled: isBoolean(isDisabled) ? isDisabled : !isDisabled,
                selected: isSelected(item)
            }, context.slots.default
                ? context.slots.default({ item, index })
                : extractProp(props.itemText, item));
    });
}
function generateSelect(props, context, ref, input, themeClasses) {
    const value = input.modelValue.value;
    const usePlaceholder = isEmpty(value) && (!!props.placeholder || !!context.slots.placeholder);
    return h('select', {
        ...context.attrs,
        ref,
        value,
        size: props.displayCount,
        multiple: isMultiple(props, input),
        class: themeClasses,
        onBlur: input.onBlur,
        onFocus: input.onFocus,
        onChange: input.onNativeInput
    }, usePlaceholder
        ? [generatePlaceholder(props, context), ...generateOptions(props, context, input)]
        : generateOptions(props, context, input));
}
export function defineSelect(eq) {
    return defineComponent({
        name: 'b-select',
        props: getBSelectPropsDefinition(eq),
        setup(props, context) {
            const selectRef = shallowRef(null);
            const input = useInput(props, selectRef);
            const { themeClasses } = useTheme(props);
            return () => {
                return h('div', { class: ['control', getControlClasses(input.isExpanded.value, !!input.icon)] }, [
                    h('span', {
                        class: ['select', ...getSelectClasses(props, input)]
                    }, [generateSelect(props, context, selectRef, input, themeClasses.value)])
                ]);
            };
        }
    });
}
// eslint-disable-next-line
export const BSelect = defineSelect();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQlNlbGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2Zvcm0vc2VsZWN0L0JTZWxlY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLDBCQUEwQixFQUFTLFFBQVEsRUFBaUIsTUFBTSxxQ0FBcUMsQ0FBQztBQUNqSCxPQUFPLEVBQVcsb0JBQW9CLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM1RSxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsUUFBUSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDbkYsT0FBTyxFQUFhLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMzRSxPQUFPLEVBQW1CLGVBQWUsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFxQixNQUFNLEtBQUssQ0FBQztBQVV6RixNQUFNLFVBQVUseUJBQXlCLENBQUksRUFBVTtJQUNyRCxPQUFPO1FBQ0wsR0FBRyxvQkFBb0IsQ0FBSSxFQUFFLENBQUM7UUFDOUIsR0FBRywwQkFBMEIsRUFBSztRQUNsQyxHQUFHLDJCQUEyQjtRQUM5QixLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsS0FBc0I7WUFDNUIsUUFBUSxFQUFFLElBQWE7U0FDeEI7UUFDRCxVQUFVLEVBQUU7WUFDVixJQUFJLEVBQUUsT0FBNEI7WUFDbEMsT0FBTyxFQUFFLEtBQUs7U0FDZjtRQUNELE9BQU8sRUFBRTtZQUNQLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQTJCO1NBQ25EO1FBQ0QsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBMkI7WUFDbEQsT0FBTyxFQUFFLE1BQU07U0FDaEI7UUFDRCxTQUFTLEVBQUU7WUFDVCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUEyQjtZQUNsRCxPQUFPLEVBQUUsT0FBTztTQUNqQjtR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QztZQUM3RCxNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sR0FBRyxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsRUFBRTtvQkFDL0YsQ0FBQyxDQUNDLE1BQU0sRUFDTjt3QkFDRSxLQUFLLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxLQUF3QixFQUFFLEtBQWMsQ0FBQyxDQUFDO3FCQUNqRixFQUNELENBQUMsY0FBYyxDQUFDLEtBQXdCLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFjLEVBQUUsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQ25HO2lCQUNGLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQztRQUNKLENBQUM7S0FDRixDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsMkJBQTJCO0FBQzNCLE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBRyxZQUFZLEVBQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnLi9zZWxlY3Quc2Fzcyc7XG5pbXBvcnQgeyBFcSB9IGZyb20gJ2ZwLXRzL2xpYi9FcSc7XG5pbXBvcnQgeyBnZXRVc2VJbnB1dFByb3BzRGVmaW5pdGlvbiwgSW5wdXQsIHVzZUlucHV0LCBVc2VJbnB1dFByb3BzIH0gZnJvbSAnLi4vLi4vLi4vY29tcG9zYWJsZXMvaW5wdXQvdXNlSW5wdXQnO1xuaW1wb3J0IHsgRXFQcm9wcywgZ2V0RXFQcm9wc0RlZmluaXRpb24gfSBmcm9tICcuLi8uLi8uLi9jb21wb3NhYmxlcy9zaGFyZWQnO1xuaW1wb3J0IHsgRGVmYXVsdFRoZW1lUHJvcHNEZWZpbml0aW9uLCB1c2VUaGVtZSB9IGZyb20gJy4uLy4uLy4uL2NvbXBvc2FibGVzL3RoZW1lJztcbmltcG9ydCB7IEV4dHJhY3RvciwgZXh0cmFjdFByb3AsIGlzQm9vbGVhbiB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2hlbHBlcnMnO1xuaW1wb3J0IHsgUHJvcFR5cGUsIFZOb2RlLCBkZWZpbmVDb21wb25lbnQsIGgsIHNoYWxsb3dSZWYsIFNldHVwQ29udGV4dCwgUmVmIH0gZnJvbSAndnVlJztcbmltcG9ydCB7IENsYXNzZXMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9tZXJnZUNsYXNzZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlbGVjdEl0ZW08VD4ge1xuICB2YWx1ZTogVDtcbiAgdGV4dDogc3RyaW5nO1xuICBpc0Rpc2FibGVkOiBib29sZWFuO1xuICBpc1NlbGVjdGVkOiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QlNlbGVjdFByb3BzRGVmaW5pdGlvbjxUPihlcT86IEVxPFQ+KSB7XG4gIHJldHVybiB7XG4gICAgLi4uZ2V0RXFQcm9wc0RlZmluaXRpb248VD4oZXEpLFxuICAgIC4uLmdldFVzZUlucHV0UHJvcHNEZWZpbml0aW9uPFQ+KCksXG4gICAgLi4uRGVmYXVsdFRoZW1lUHJvcHNEZWZpbml0aW9uLFxuICAgIGl0ZW1zOiB7XG4gICAgICB0eXBlOiBBcnJheSBhcyBQcm9wVHlwZTxUW10+LFxuICAgICAgcmVxdWlyZWQ6IHRydWUgYXMgY29uc3RcbiAgICB9LFxuICAgIGlzTXVsdGlwbGU6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4gYXMgUHJvcFR5cGU8Ym9vbGVhbj4sXG4gICAgICBkZWZhdWx0OiBmYWxzZVxuICAgIH0sXG4gICAgaXRlbUtleToge1xuICAgICAgdHlwZTogW1N0cmluZywgRnVuY3Rpb25dIGFzIFByb3BUeXBlPEV4dHJhY3RvcjxUPj5cbiAgICB9LFxuICAgIGl0ZW1UZXh0OiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBGdW5jdGlvbl0gYXMgUHJvcFR5cGU8RXh0cmFjdG9yPFQ+PixcbiAgICAgIGRlZmF1bHQ6ICd0ZXh0J1xuICAgIH0sXG4gICAgaXRlbVZhbHVlOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBGdW5jdGlvbl0gYXMgUHJvcFR5cGU8RXh0cmFjdG9yPFQ+PixcbiAgICAgIGRlZmF1bHQ6ICd2YWx1ZSdcbiAgICB9LFxuICAgIGl0ZW1EaXNhYmxlZDoge1xuICAgICAgdHlwZTogW1N0cmluZywgRnVuY3Rpb25dIGFzIFByb3BUeXBlPEV4dHJhY3RvcjxUPj4sXG4gICAgICBkZWZhdWx0OiAnaXNEaXNhYmxlZCdcbiAgICB9LFxuICAgIGRpc3BsYXlDb3VudDoge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXVxuICAgIH1cbiAgfTtcbn1cblxuZXhwb3J0IHR5cGUgQlNlbGVjdFByb3BzPFQ+ID0gRXFQcm9wczxUPiAmXG4gIFVzZUlucHV0UHJvcHM8VD4gJiB7XG4gICAgaXRlbXM6IFRbXTtcbiAgICBpc011bHRpcGxlOiBib29sZWFuO1xuICAgIGl0ZW1LZXk/OiBFeHRyYWN0b3I8VD47XG4gICAgaXRlbVRleHQ6IEV4dHJhY3RvcjxUPjtcbiAgICBpdGVtVmFsdWU6IEV4dHJhY3RvcjxUPjtcbiAgICBpdGVtRGlzYWJsZWQ6IEV4dHJhY3RvcjxUPjtcbiAgICBkaXNwbGF5Q291bnQ/OiBzdHJpbmcgfCBudW1iZXI7XG4gIH07XG5cbmZ1bmN0aW9uIGdldENvbnRyb2xDbGFzc2VzKGlzRXhwYW5kZWQ6IGJvb2xlYW4sIGhhc0ljb246IGJvb2xlYW4pIHtcbiAgcmV0dXJuIHtcbiAgICAnaXMtZXhwYW5kZWQnOiBpc0V4cGFuZGVkLFxuICAgICdoYXMtaWNvbnMtbGVmdCc6IGhhc0ljb25cbiAgfTtcbn1cblxuZnVuY3Rpb24gaXNNdWx0aXBsZTxUPihwcm9wczogQlNlbGVjdFByb3BzPFQ+LCBpbnB1dDogSW5wdXQpIHtcbiAgcmV0dXJuIHByb3BzLmlzTXVsdGlwbGUgfHwgKHByb3BzLmlzTXVsdGlwbGUgPT09IHVuZGVmaW5lZCAmJiBBcnJheS5pc0FycmF5KGlucHV0Lm1vZGVsVmFsdWUudmFsdWUpKTtcbn1cblxuZnVuY3Rpb24gaXNFbXB0eSh2YWw6IHVua25vd24pIHtcbiAgcmV0dXJuIHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IHVuZGVmaW5lZCB8fCAoQXJyYXkuaXNBcnJheSh2YWwpICYmIHZhbC5sZW5ndGggPT09IDApO1xufVxuXG5mdW5jdGlvbiBnZXRTZWxlY3RDbGFzc2VzPFQ+KHByb3BzOiBCU2VsZWN0UHJvcHM8VD4sIGlucHV0OiBJbnB1dCk6IENsYXNzZXNbXSB7XG4gIHJldHVybiBbXG4gICAgaW5wdXQuc2l6ZS52YWx1ZSxcbiAgICBwcm9wcy52YXJpYW50LFxuICAgIHtcbiAgICAgICdpcy1mdWxsd2lkdGgnOiBpbnB1dC5pc0Z1bGx3aWR0aC52YWx1ZSxcbiAgICAgICdpcy1sb2FkaW5nJzogcHJvcHMuaXNMb2FkaW5nLFxuICAgICAgJ2lzLW11bHRpcGxlJzogaXNNdWx0aXBsZShwcm9wcywgaW5wdXQpLFxuICAgICAgJ2lzLXJvdW5kZWQnOiBwcm9wcy5pc1JvdW5kZWQsXG4gICAgICAnaXMtZW1wdHknOiBpc0VtcHR5KGlucHV0Lm1vZGVsVmFsdWUudmFsdWUpXG4gICAgfVxuICBdO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVBsYWNlaG9sZGVyPFQ+KHByb3BzOiBCU2VsZWN0UHJvcHM8VD4sIGNvbnRleHQ6IFNldHVwQ29udGV4dCk6IFZOb2RlIHtcbiAgcmV0dXJuIGgoXG4gICAgJ29wdGlvbicsXG4gICAge1xuICAgICAgdmFsdWU6ICcnLFxuICAgICAgZGlzYWJsZWQ6IHRydWUsXG4gICAgICBzZWxlY3RlZDogdHJ1ZVxuICAgIH0sXG4gICAgY29udGV4dC5zbG90cy5wbGFjZWhvbGRlciA/IGNvbnRleHQuc2xvdHMucGxhY2Vob2xkZXIoKSA6IHByb3BzLnBsYWNlaG9sZGVyXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldElzU2VsZWN0ZWQ8VD4ocHJvcHM6IEJTZWxlY3RQcm9wczxUPiwgaW5wdXQ6IElucHV0KSB7XG4gIHJldHVybiAodmFsOiBUKSA9PiB7XG4gICAgY29uc3QgZXF1YWxzID0gcHJvcHMuZXEuZXF1YWxzO1xuICAgIGNvbnN0IHZhbHVlID0gaW5wdXQubW9kZWxWYWx1ZS52YWx1ZTtcbiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoaXNNdWx0aXBsZShwcm9wcywgaW5wdXQpKSB7XG4gICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZS5zb21lKHYgPT4gZXF1YWxzKHYsIHZhbCkpIDogZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBlcXVhbHModmFsLCB2YWx1ZSBhcyBUKTtcbiAgICB9XG4gIH07XG59XG5mdW5jdGlvbiBnZW5lcmF0ZU9wdGlvbnM8VD4ocHJvcHM6IEJTZWxlY3RQcm9wczxUPiwgY29udGV4dDogU2V0dXBDb250ZXh0LCBpbnB1dDogSW5wdXQpIHtcbiAgY29uc3QgaXNTZWxlY3RlZCA9IGdldElzU2VsZWN0ZWQocHJvcHMsIGlucHV0KTtcbiAgcmV0dXJuIHByb3BzLml0ZW1zLm1hcCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICBjb25zdCBpc0Rpc2FibGVkID0gZXh0cmFjdFByb3AocHJvcHMuaXRlbURpc2FibGVkLCBpdGVtKTtcblxuICAgIHJldHVybiBjb250ZXh0LnNsb3RzLm9wdGlvblxuICAgICAgPyBjb250ZXh0LnNsb3RzLm9wdGlvbih7IGl0ZW0sIGluZGV4IH0pXG4gICAgICA6IGgoXG4gICAgICAgICAgJ29wdGlvbicsXG4gICAgICAgICAge1xuICAgICAgICAgICAga2V5OiBwcm9wcy5pdGVtS2V5ID8gKChleHRyYWN0UHJvcChwcm9wcy5pdGVtS2V5LCBpdGVtKSBhcyB1bmtub3duKSBhcyBzdHJpbmcpIDogU3RyaW5nKGluZGV4KSxcbiAgICAgICAgICAgIHZhbHVlOiBleHRyYWN0UHJvcChwcm9wcy5pdGVtVmFsdWUsIGl0ZW0pLFxuICAgICAgICAgICAgZGlzYWJsZWQ6IGlzQm9vbGVhbihpc0Rpc2FibGVkKSA/IGlzRGlzYWJsZWQgOiAhaXNEaXNhYmxlZCxcbiAgICAgICAgICAgIHNlbGVjdGVkOiBpc1NlbGVjdGVkKGl0ZW0pXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjb250ZXh0LnNsb3RzLmRlZmF1bHRcbiAgICAgICAgICAgID8gY29udGV4dC5zbG90cy5kZWZhdWx0KHsgaXRlbSwgaW5kZXggfSlcbiAgICAgICAgICAgIDogKChleHRyYWN0UHJvcChwcm9wcy5pdGVtVGV4dCwgaXRlbSkgYXMgdW5rbm93bikgYXMgc3RyaW5nKVxuICAgICAgICApO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVTZWxlY3Q8VD4oXG4gIHByb3BzOiBCU2VsZWN0UHJvcHM8VD4sXG4gIGNvbnRleHQ6IFNldHVwQ29udGV4dCxcbiAgcmVmOiBSZWY8SFRNTEVsZW1lbnQ+LFxuICBpbnB1dDogSW5wdXQsXG4gIHRoZW1lQ2xhc3NlczogQ2xhc3Nlc1xuKTogVk5vZGUge1xuICBjb25zdCB2YWx1ZSA9IGlucHV0Lm1vZGVsVmFsdWUudmFsdWU7XG4gIGNvbnN0IHVzZVBsYWNlaG9sZGVyID0gaXNFbXB0eSh2YWx1ZSkgJiYgKCEhcHJvcHMucGxhY2Vob2xkZXIgfHwgISFjb250ZXh0LnNsb3RzLnBsYWNlaG9sZGVyKTtcbiAgcmV0dXJuIGgoXG4gICAgJ3NlbGVjdCcsXG4gICAge1xuICAgICAgLi4uY29udGV4dC5hdHRycyxcbiAgICAgIHJlZixcbiAgICAgIHZhbHVlLFxuICAgICAgc2l6ZTogcHJvcHMuZGlzcGxheUNvdW50LFxuICAgICAgbXVsdGlwbGU6IGlzTXVsdGlwbGUocHJvcHMsIGlucHV0KSxcbiAgICAgIGNsYXNzOiB0aGVtZUNsYXNzZXMsXG4gICAgICBvbkJsdXI6IGlucHV0Lm9uQmx1cixcbiAgICAgIG9uRm9jdXM6IGlucHV0Lm9uRm9jdXMsXG4gICAgICBvbkNoYW5nZTogaW5wdXQub25OYXRpdmVJbnB1dFxuICAgIH0sXG4gICAgdXNlUGxhY2Vob2xkZXJcbiAgICAgID8gW2dlbmVyYXRlUGxhY2Vob2xkZXIocHJvcHMsIGNvbnRleHQpLCAuLi5nZW5lcmF0ZU9wdGlvbnMocHJvcHMsIGNvbnRleHQsIGlucHV0KV1cbiAgICAgIDogZ2VuZXJhdGVPcHRpb25zKHByb3BzLCBjb250ZXh0LCBpbnB1dClcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZVNlbGVjdDxUPihlcT86IEVxPFQ+KSB7XG4gIHJldHVybiBkZWZpbmVDb21wb25lbnQoe1xuICAgIG5hbWU6ICdiLXNlbGVjdCcsXG4gICAgcHJvcHM6IGdldEJTZWxlY3RQcm9wc0RlZmluaXRpb248VD4oZXEpLFxuICAgIHNldHVwKHByb3BzLCBjb250ZXh0KSB7XG4gICAgICBjb25zdCBzZWxlY3RSZWYgPSBzaGFsbG93UmVmKChudWxsIGFzIHVua25vd24pIGFzIEhUTUxFbGVtZW50KTtcbiAgICAgIGNvbnN0IGlucHV0ID0gdXNlSW5wdXQocHJvcHMgYXMgVXNlSW5wdXRQcm9wczxUPiwgc2VsZWN0UmVmKTtcbiAgICAgIGNvbnN0IHsgdGhlbWVDbGFzc2VzIH0gPSB1c2VUaGVtZShwcm9wcyk7XG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICByZXR1cm4gaCgnZGl2JywgeyBjbGFzczogWydjb250cm9sJywgZ2V0Q29udHJvbENsYXNzZXMoaW5wdXQuaXNFeHBhbmRlZC52YWx1ZSwgISFpbnB1dC5pY29uKV0gfSwgW1xuICAgICAgICAgIGgoXG4gICAgICAgICAgICAnc3BhbicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGNsYXNzOiBbJ3NlbGVjdCcsIC4uLmdldFNlbGVjdENsYXNzZXMocHJvcHMgYXMgQlNlbGVjdFByb3BzPFQ+LCBpbnB1dCBhcyBJbnB1dCldXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgW2dlbmVyYXRlU2VsZWN0KHByb3BzIGFzIEJTZWxlY3RQcm9wczxUPiwgY29udGV4dCwgc2VsZWN0UmVmLCBpbnB1dCBhcyBJbnB1dCwgdGhlbWVDbGFzc2VzLnZhbHVlKV1cbiAgICAgICAgICApXG4gICAgICAgIF0pO1xuICAgICAgfTtcbiAgICB9XG4gIH0pO1xufVxuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmVcbmV4cG9ydCBjb25zdCBCU2VsZWN0ID0gZGVmaW5lU2VsZWN0PGFueT4oKTtcbiJdfQ==