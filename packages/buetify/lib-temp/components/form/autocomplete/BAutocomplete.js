import './autocomplete.sass';
import { StaticUseInputProps } from '../../../composables/input/useInput';
import { getUseModelPropsDefinition } from '../../../composables/model/useModel';
import { useProxy } from '../../../composables/proxy';
import { getEqPropsDefinition } from '../../../composables/shared';
import { useThemePropsDefinition } from '../../../composables/theme';
import { constEmptyArray, extractProp, toggleListItem } from '../../../utils/helpers';
import { DropdownThemeMap } from '../../dropdown';
import BDropdown from '../../dropdown/BDropdown';
import { isArrowDownEvent, isArrowUpEvent, isEnterEvent, isEscEvent, isTabEvent } from '../../../utils/eventHelpers';
import { constant, constVoid } from 'fp-ts/lib/function';
import BDropdownDivider from '../../dropdown/BDropdownDivider';
import BDropdownItem from '../../dropdown/BDropdownItem';
import { head, isEmpty, lookup } from 'fp-ts/lib/Array';
import { alt, chain, fold, fromNullable, isSome, map, none, some, toUndefined } from 'fp-ts/lib/Option';
import { pipe } from 'fp-ts/lib/pipeable';
import { defineComponent, shallowRef, computed, onBeforeUpdate, nextTick, toRef, h } from 'vue';
import { BInput } from '../input';
function getActiveDescendentId(selectedItems, itemId) {
    return pipe(selectedItems, head, map(item => extractProp(itemId, item)), toUndefined);
}
function getAutocompleteItems(items, selectedItems, itemId, itemText, eq, hoveredItem) {
    return items.map((item, index) => ({
        id: extractProp(itemId, item),
        isSelected: selectedItems.some(i => eq.equals(i, item)),
        isHovered: isSome(hoveredItem) ? hoveredItem.value.id === extractProp(itemId, item) : false,
        text: extractProp(itemText, item),
        value: item,
        index
    }));
}
function getSetSelected(props, closeDropdown, inputModel, selectedItemsModel) {
    const toggle = toggleListItem(props.eq);
    return (item) => {
        inputModel.value = props.clearOnSelect ? '' : extractProp(props.itemText, item.value);
        selectedItemsModel.value = toggle(item.value, selectedItemsModel.value || []);
        if (props.closeOnSelect) {
            closeDropdown();
        }
    };
}
function getSetHovered(hoveredItem, templateItems) {
    return (item) => {
        const newItem = fromNullable(item);
        if (isSome(newItem)) {
            hoveredItem.value = newItem;
            pipe(newItem, map(item => item.index), chain(index => lookup(index, templateItems.value)), fold(constant(constVoid), li => () => li.focus && li.focus()))();
        }
    };
}
function getOnKeydown(autocompleteItems, hoveredItem, closeDropdown, setSelected, setHovered) {
    function onArrowPress(isUp) {
        pipe(hoveredItem.value, map(item => item.index), alt(() => some(0)), chain(index => lookup(isUp ? Math.max(index - 1, 0) : Math.min(index + 1, autocompleteItems.value.length - 1), autocompleteItems.value)), fold(constant(constVoid), newItem => () => setHovered(newItem)))();
    }
    return function onKeydown(event) {
        if (isEnterEvent(event)) {
            event.preventDefault();
            if (isSome(hoveredItem.value)) {
                setSelected(hoveredItem.value.value);
            }
        }
        else if (isTabEvent(event)) {
            event.preventDefault();
            if (isSome(hoveredItem.value)) {
                setSelected(hoveredItem.value.value);
            }
            else {
                nextTick(closeDropdown);
            }
        }
        else if (isArrowUpEvent(event)) {
            event.preventDefault();
            onArrowPress(true);
        }
        else if (isArrowDownEvent(event)) {
            event.preventDefault();
            onArrowPress(false);
        }
        else if (isEscEvent(event)) {
            event.preventDefault();
            nextTick(closeDropdown);
        }
    };
}
function getGenerateItem(itemsRef, length, onKeydown, setSelected, setHovered, slots) {
    return function generateItem(item, index) {
        return h(BDropdownItem, {
            key: item.id,
            ref: (el) => {
                itemsRef.value[index] = el;
            },
            id: item.id,
            isActive: item.isSelected,
            tabindex: item.isSelected ? -1 : 0,
            'aria-selected': item.isSelected,
            'aria-label': `Option ${index + 1} of ${length.value}`,
            class: { 'is-hovered': item.isHovered },
            onClick: () => setSelected(item),
            onMouseenter: () => setHovered(item),
            onKeydown
        }, () => (slots.default ? slots.default({ option: item, index }) : item.text));
    };
}
function generateHeaderItem(slots) {
    return h('li', { tabindex: -1 }, [h(BDropdownItem, { tag: 'div' }, slots.header())]);
}
function generateLoadingItem(slots) {
    return h('li', { tabindex: -1 }, [
        h(BDropdownItem, { tag: 'div' }, () => (slots.loading ? slots.loading() : 'Loading results...'))
    ]);
}
function generateEmptyItem(modelValue, slots) {
    return h(BDropdownItem, {
        class: 'is-disabled'
    }, () => (slots.empty ? slots.empty() : modelValue ? `No results` : `No results for ${modelValue}`));
}
function defineAutocomplete() {
    return defineComponent({
        name: 'b-autocomplete',
        props: {
            ...StaticUseInputProps,
            ...getEqPropsDefinition(),
            ...useThemePropsDefinition(DropdownThemeMap),
            ...getUseModelPropsDefinition(),
            ...getUseModelPropsDefinition('selectedItems', 'onUpdate:selectedItems'),
            selectedItems: {
                type: Array,
                required: true
            },
            items: {
                type: Array,
                default: constEmptyArray
            },
            itemFilter: {
                type: Function,
                required: false
            },
            itemId: {
                type: [String, Function],
                default: 'id'
            },
            itemText: {
                type: [String, Function],
                default: 'text'
            },
            closeOnSelect: {
                type: Boolean,
                default: true
            },
            clearOnSelect: {
                type: Boolean,
                default: true
            },
            openOnFocus: {
                type: Boolean,
                default: true
            },
            onSelected: {
                type: Function,
                required: false
            }
        },
        setup(props, { slots }) {
            const { value: searchValue } = useProxy(computed(() => props.modelValue ?? ''), toRef(props, 'onUpdate:modelValue'));
            const { value: selectedItems } = useProxy(toRef(props, 'selectedItems'), toRef(props, 'onUpdate:selectedItems'));
            const itemsRef = shallowRef([]);
            const filteredItems = computed(() => props.itemFilter ? props.items.filter(props.itemFilter(searchValue.value)) : props.items);
            onBeforeUpdate(() => (itemsRef.value = []));
            const dropdown = shallowRef(null);
            function close() {
                dropdown.value && dropdown.value.toggle.setOff();
            }
            const hoveredItem = shallowRef(none);
            const activeDescendentId = computed(() => getActiveDescendentId(props.selectedItems, props.itemId));
            const autocompleteItems = computed(() => getAutocompleteItems(filteredItems.value, selectedItems.value, props.itemId, props.itemText, props.eq, hoveredItem.value));
            const numberOfItems = computed(() => autocompleteItems.value.length);
            const setSelected = getSetSelected(props, close, searchValue, selectedItems);
            const setHovered = getSetHovered(hoveredItem, itemsRef);
            const onKeydown = getOnKeydown(autocompleteItems, hoveredItem, close, setSelected, setHovered);
            const generateItem = getGenerateItem(itemsRef, numberOfItems, onKeydown, setSelected, setHovered, slots);
            return () => {
                return h(BDropdown, {
                    ref: dropdown,
                    isMobileModal: false,
                    class: ['b-autocomplete', { 'is-expanded': props.isExpanded }]
                }, {
                    trigger: () => {
                        return h(BInput, {
                            modelValue: searchValue.value,
                            type: 'text',
                            size: props.size,
                            isLoading: props.isLoading,
                            isRounded: props.isRounded,
                            icon: props.icon,
                            maxlength: props.maxlength,
                            autocomplete: props.autocomplete || 'list',
                            placeholder: props.placeholder,
                            role: 'searchbox',
                            'aria-activedescendant': activeDescendentId.value,
                            'onUpdate:modelValue': (val) => {
                                searchValue.value = val;
                            },
                            onFocus: () => {
                                if (props.openOnFocus) {
                                    nextTick(() => {
                                        const d = dropdown.value;
                                        if (d && d.toggle.isOff.value) {
                                            d.toggle.setOn();
                                        }
                                    });
                                }
                            },
                            onBlur: props.onBlur,
                            onKeydown
                        });
                    },
                    default: () => {
                        let nodes;
                        if (props.isLoading) {
                            nodes = [generateLoadingItem(slots)];
                        }
                        else {
                            nodes = isEmpty(autocompleteItems.value)
                                ? [generateEmptyItem(searchValue.value, slots)]
                                : autocompleteItems.value.map(generateItem);
                            if (slots.header) {
                                nodes.unshift(generateHeaderItem(slots), h(BDropdownDivider));
                            }
                        }
                        return nodes;
                    }
                });
            };
        }
    });
}
export const BAutocomplete = defineAutocomplete();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQkF1dG9jb21wbGV0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2Zvcm0vYXV0b2NvbXBsZXRlL0JBdXRvY29tcGxldGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxxQkFBcUIsQ0FBQztBQUc3QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUMxRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNqRixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDbkUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDckUsT0FBTyxFQUFFLGVBQWUsRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEQsT0FBTyxTQUFTLE1BQU0sMEJBQTBCLENBQUM7QUFDakQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3JILE9BQU8sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUF3QixNQUFNLG9CQUFvQixDQUFDO0FBQy9FLE9BQU8sZ0JBQWdCLE1BQU0saUNBQWlDLENBQUM7QUFDL0QsT0FBTyxhQUFhLE1BQU0sOEJBQThCLENBQUM7QUFDekQsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBVSxJQUFJ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QUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUU7NENBQzdCLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7eUNBQ2xCO29DQUNILENBQUMsQ0FBQyxDQUFDO2lDQUNKOzRCQUNILENBQUM7NEJBQ0QsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNOzRCQUNwQixTQUFTO3lCQUNWLENBQUMsQ0FBQztvQkFDTCxDQUFDO29CQUNELE9BQU8sRUFBRSxHQUFHLEVBQUU7d0JBQ1osSUFBSSxLQUFjLENBQUM7d0JBQ25CLElBQUksS0FBSyxDQUFDLFNBQVMsRUFBRTs0QkFDbkIsS0FBSyxHQUFHLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQzt5QkFDdEM7NkJBQU07NEJBQ0wsS0FBSyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUM7Z0NBQ3RDLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0NBQy9DLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDOzRCQUM5QyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7Z0NBQ2hCLEtBQUssQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQzs2QkFDL0Q7eUJBQ0Y7d0JBQ0QsT0FBTyxLQUFLLENBQUM7b0JBQ2YsQ0FBQztpQkFDRixDQUNGLENBQUM7WUFDSixDQUFDLENBQUM7UUFDSixDQUFDO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxrQkFBa0IsRUFBTyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICcuL2F1dG9jb21wbGV0ZS5zYXNzJztcbmltcG9ydCB7IEVxIH0gZnJvbSAnZnAtdHMvbGliL0VxJztcbmltcG9ydCB7IElPIH0gZnJvbSAnZnAtdHMvbGliL0lPJztcbmltcG9ydCB7IFN0YXRpY1VzZUlucHV0UHJvcHMgfSBmcm9tICcuLi8uLi8uLi9jb21wb3NhYmxlcy9pbnB1dC91c2VJbnB1dCc7XG5pbXBvcnQgeyBnZXRVc2VNb2RlbFByb3BzRGVmaW5pdGlvbiB9IGZyb20gJy4uLy4uLy4uL2NvbXBvc2FibGVzL21vZGVsL3VzZU1vZGVsJztcbmltcG9ydCB7IHVzZVByb3h5IH0gZnJvbSAnLi4vLi4vLi4vY29tcG9zYWJsZXMvcHJveHknO1xuaW1wb3J0IHsgZ2V0RXFQcm9wc0RlZmluaXRpb24gfSBmcm9tICcuLi8uLi8uLi9jb21wb3NhYmxlcy9zaGFyZWQnO1xuaW1wb3J0IHsgdXNlVGhlbWVQcm9wc0RlZmluaXRpb24gfSBmcm9tICcuLi8uLi8uLi9jb21wb3NhYmxlcy90aGVtZSc7XG5pbXBvcnQgeyBjb25zdEVtcHR5QXJyYXksIGV4dHJhY3RQcm9wLCB0b2dnbGVMaXN0SXRlbSB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2hlbHBlcnMnO1xuaW1wb3J0IHsgRHJvcGRvd25UaGVtZU1hcCB9IGZyb20gJy4uLy4uL2Ryb3Bkb3duJztcbmltcG9ydCBCRHJvcGRvd24gZnJvbSAnLi4vLi4vZHJvcGRvd24vQkRyb3Bkb3duJztcbmltcG9ydCB7IGlzQXJyb3dEb3duRXZlbnQsIGlzQXJyb3dVcEV2ZW50LCBpc0VudGVyRXZlbnQsIGlzRXNjRXZlbnQsIGlzVGFiRXZlbnQgfSBmcm9tICcuLi8uLi8uLi91dGlscy9ldmVudEhlbHBlcnMnO1xuaW1wb3J0IHsgY29uc3RhbnQsIGNvbnN0Vm9pZCwgRnVuY3Rpb25OLCBQcmVkaWNhdGUgfSBmcm9tICdmcC10cy9saWIvZnVuY3Rpb24nO1xuaW1wb3J0IEJEcm9wZG93bkRpdmlkZXIgZnJvbSAnLi4vLi4vZHJvcGRvd24vQkRyb3Bkb3duRGl2aWRlcic7XG5pbXBvcnQgQkRyb3Bkb3duSXRlbSBmcm9tICcuLi8uLi9kcm9wZG93bi9CRHJvcGRvd25JdGVtJztcbmltcG9ydCB7IGhlYWQsIGlzRW1wdHksIGxvb2t1cCB9IGZyb20gJ2ZwLXRzL2xpYi9BcnJheSc7XG5pbXBvcnQgeyBhbHQsIGNoYWluLCBmb2xkLCBmcm9tTnVsbGFibGUsIGlzU29tZSwgbWFwLCBub25lLCBPcHRpb24sIHNvbWUsIHRvVW5kZWZpbmVkIH0gZnJvbSAnZnAtdHMvbGliL09wdGlvbic7XG5pbXBvcnQgeyBwaXBlIH0gZnJvbSAnZnAtdHMvbGliL3BpcGVhYmxlJztcbmltcG9ydCB7XG4gIGRlZmluZUNvbXBvbmVudCxcbiAgUHJvcFR5cGUsXG4gIFZOb2RlLFxuICBSZWYsXG4gIHNoYWxsb3dSZWYsXG4gIGNvbXB1dGVkLFxuICBvbkJlZm9yZVVwZGF0ZSxcbiAgbmV4dFRpY2ssXG4gIHRvUmVmLFxuICBTbG90cyxcbiAgaFxufSBmcm9tICd2dWUnO1xuXG5pbXBvcnQgeyBCSW5wdXQgfSBmcm9tICcuLi9pbnB1dCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0b2NvbXBsZXRlSXRlbTxUPiB7XG4gIGlkOiBzdHJpbmc7XG4gIGlzU2VsZWN0ZWQ6IGJvb2xlYW47XG4gIGlzSG92ZXJlZDogYm9vbGVhbjtcbiAgdGV4dDogc3RyaW5nO1xuICB2YWx1ZTogVDtcbiAgaW5kZXg6IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gZ2V0QWN0aXZlRGVzY2VuZGVudElkPFQ+KHNlbGVjdGVkSXRlbXM6IFRbXSwgaXRlbUlkOiBrZXlvZiBUIHwgKChpdGVtOiBUKSA9PiBzdHJpbmcpKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgcmV0dXJuIHBpcGUoXG4gICAgc2VsZWN0ZWRJdGVtcyxcbiAgICBoZWFkLFxuICAgIG1hcChpdGVtID0+IGV4dHJhY3RQcm9wKGl0ZW1JZCBhcyBhbnksIGl0ZW0pIGFzIGFueSksXG4gICAgdG9VbmRlZmluZWRcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0QXV0b2NvbXBsZXRlSXRlbXM8VD4oXG4gIGl0ZW1zOiBUW10sXG4gIHNlbGVjdGVkSXRlbXM6IFRbXSxcbiAgaXRlbUlkOiBrZXlvZiBUIHwgKChpdGVtOiBUKSA9PiBzdHJpbmcpLFxuICBpdGVtVGV4dDoga2V5b2YgVCB8ICgoaXRlbTogVCkgPT4gc3RyaW5nKSxcbiAgZXE6IEVxPFQ+LFxuICBob3ZlcmVkSXRlbTogT3B0aW9uPEF1dG9jb21wbGV0ZUl0ZW08VD4+XG4pOiBBdXRvY29tcGxldGVJdGVtPFQ+W10ge1xuICByZXR1cm4gaXRlbXMubWFwKChpdGVtLCBpbmRleCkgPT4gKHtcbiAgICBpZDogZXh0cmFjdFByb3AoaXRlbUlkIGFzIGFueSwgaXRlbSkgYXMgYW55LFxuICAgIGlzU2VsZWN0ZWQ6IHNlbGVjdGVkSXRlbXMuc29tZShpID0+IGVxLmVxdWFscyhpLCBpdGVtKSksXG4gICAgaXNIb3ZlcmVkOiBpc1NvbWUoaG92ZXJlZEl0ZW0pID8gaG92ZXJlZEl0ZW0udmFsdWUuaWQgPT09IChleHRyYWN0UHJvcChpdGVtSWQgYXMgYW55LCBpdGVtKSBhcyBhbnkpIDogZmFsc2UsXG4gICAgdGV4dDogZXh0cmFjdFByb3AoaXRlbVRleHQgYXMgYW55LCBpdGVtKSBhcyBhbnksXG4gICAgdmFsdWU6IGl0ZW0sXG4gICAgaW5kZXhcbiAgfSkpO1xufVxuXG5pbnRlcmZhY2UgR2V0U2V0U2VsZWN0ZWRQcm9wczxUPiB7XG4gIGVxOiBFcTxUPjtcbiAgaXRlbVRleHQ6IGFueTtcbiAgY2xlYXJPblNlbGVjdDogYm9vbGVhbjtcbiAgY2xvc2VPblNlbGVjdDogYm9vbGVhbjtcbn1cblxuZnVuY3Rpb24gZ2V0U2V0U2VsZWN0ZWQ8VD4oXG4gIHByb3BzOiBHZXRTZXRTZWxlY3RlZFByb3BzPFQ+LFxuICBjbG9zZURyb3Bkb3duOiBJTzx2b2lkPixcbiAgaW5wdXRNb2RlbDogUmVmPHN0cmluZz4sXG4gIHNlbGVjdGVkSXRlbXNNb2RlbDogUmVmPFRbXT5cbik6IFNldFNlbGVjdGVkPFQ+IHtcbiAgY29uc3QgdG9nZ2xlID0gdG9nZ2xlTGlzdEl0ZW0ocHJvcHMuZXEpO1xuICByZXR1cm4gKGl0ZW06IEF1dG9jb21wbGV0ZUl0ZW08VD4pID0+IHtcbiAgICBpbnB1dE1vZGVsLnZhbHVlID0gcHJvcHMuY2xlYXJPblNlbGVjdCA/ICcnIDogKGV4dHJhY3RQcm9wKHByb3BzLml0ZW1UZXh0LCBpdGVtLnZhbHVlKSBhcyBhbnkpO1xuICAgIHNlbGVjdGVkSXRlbXNNb2RlbC52YWx1ZSA9IHRvZ2dsZShpdGVtLnZhbHVlLCBzZWxlY3RlZEl0ZW1zTW9kZWwudmFsdWUgfHwgW10pO1xuICAgIGlmIChwcm9wcy5jbG9zZU9uU2VsZWN0KSB7XG4gICAgICBjbG9zZURyb3Bkb3duKCk7XG4gICAgfVxuICB9O1xufVxuXG5pbnRlcmZhY2UgU2V0U2VsZWN0ZWQ8VD4ge1xuICAoaXRlbTogQXV0b2NvbXBsZXRlSXRlbTxUPik6IHZvaWQ7XG59XG5cbmZ1bmN0aW9uIGdldFNldEhvdmVyZWQ8VD4oXG4gIGhvdmVyZWRJdGVtOiBSZWY8T3B0aW9uPEF1dG9jb21wbGV0ZUl0ZW08VD4+PixcbiAgdGVtcGxhdGVJdGVtczogUmVmPEhUTUxFbGVtZW50W10+XG4pOiBTZXRIb3ZlcmVkPFQ+IHtcbiAgcmV0dXJuIChpdGVtOiBBdXRvY29tcGxldGVJdGVtPFQ+IHwgdW5kZWZpbmVkKSA9PiB7XG4gICAgY29uc3QgbmV3SXRlbSA9IGZyb21OdWxsYWJsZShpdGVtKTtcbiAgICBpZiAoaXNTb21lKG5ld0l0ZW0pKSB7XG4gICAgICBob3ZlcmVkSXRlbS52YWx1ZSA9IG5ld0l0ZW07XG4gICAgICBwaXBlKFxuICAgICAgICBuZXdJdGVtLFxuICAgICAgICBtYXAoaXRlbSA9PiBpdGVtLmluZGV4KSxcbiAgICAgICAgY2hhaW4oaW5kZXggPT4gbG9va3VwKGluZGV4LCB0ZW1wbGF0ZUl0ZW1zLnZhbHVlKSksXG4gICAgICAgIGZvbGQoY29uc3RhbnQoY29uc3RWb2lkKSwgbGkgPT4gKCkgPT4gbGkuZm9jdXMgJiYgbGkuZm9jdXMoKSlcbiAgICAgICkoKTtcbiAgICB9XG4gIH07XG59XG5cbmludGVyZmFjZSBTZXRIb3ZlcmVkPFQ+IHtcbiAgKGl0ZW0/OiBBdXRvY29tcGxldGVJdGVtPFQ+IHwgdW5kZWZpbmVkKTogdm9pZDtcbn1cblxuZnVuY3Rpb24gZ2V0T25LZXlkb3duPFQ+KFxuICBhdXRvY29tcGxldGVJdGVtczogUmVmPEF1dG9jb21wbGV0ZUl0ZW08VD5bXT4sXG4gIGhvdmVyZWRJdGVtOiBSZWY8T3B0aW9uPEF1dG9jb21wbGV0ZUl0ZW08VD4+PixcbiAgY2xvc2VEcm9wZG93bjogSU88dm9pZD4sXG4gIHNldFNlbGVjdGVkOiBGdW5jdGlvbk48W0F1dG9jb21wbGV0ZUl0ZW08VD5dLCB2b2lkPixcbiAgc2V0SG92ZXJlZDogRnVuY3Rpb25OPFtBdXRvY29tcGxldGVJdGVtPFQ+XSwgdm9pZD5cbikge1xuICBmdW5jdGlvbiBvbkFycm93UHJlc3MoaXNVcDogYm9vbGVhbikge1xuICAgIHBpcGUoXG4gICAgICBob3ZlcmVkSXRlbS52YWx1ZSxcbiAgICAgIG1hcChpdGVtID0+IGl0ZW0uaW5kZXgpLFxuICAgICAgYWx0KCgpID0+IHNvbWUoMCkpLFxuICAgICAgY2hhaW4oaW5kZXggPT5cbiAgICAgICAgbG9va3VwKFxuICAgICAgICAgIGlzVXAgPyBNYXRoLm1heChpbmRleCAtIDEsIDApIDogTWF0aC5taW4oaW5kZXggKyAxLCBhdXRvY29tcGxldGVJdGVtcy52YWx1ZS5sZW5ndGggLSAxKSxcbiAgICAgICAgICBhdXRvY29tcGxldGVJdGVtcy52YWx1ZSBhcyBBdXRvY29tcGxldGVJdGVtPFQ+W11cbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIGZvbGQoY29uc3RhbnQoY29uc3RWb2lkKSwgbmV3SXRlbSA9PiAoKSA9PiBzZXRIb3ZlcmVkKG5ld0l0ZW0pKVxuICAgICkoKTtcbiAgfVxuICByZXR1cm4gZnVuY3Rpb24gb25LZXlkb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgaWYgKGlzRW50ZXJFdmVudChldmVudCkpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBpZiAoaXNTb21lKGhvdmVyZWRJdGVtLnZhbHVlKSkge1xuICAgICAgICBzZXRTZWxlY3RlZChob3ZlcmVkSXRlbS52YWx1ZS52YWx1ZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChpc1RhYkV2ZW50KGV2ZW50KSkge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmIChpc1NvbWUoaG92ZXJlZEl0ZW0udmFsdWUpKSB7XG4gICAgICAgIHNldFNlbGVjdGVkKGhvdmVyZWRJdGVtLnZhbHVlLnZhbHVlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHRUaWNrKGNsb3NlRHJvcGRvd24pO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaXNBcnJvd1VwRXZlbnQoZXZlbnQpKSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgb25BcnJvd1ByZXNzKHRydWUpO1xuICAgIH0gZWxzZSBpZiAoaXNBcnJvd0Rvd25FdmVudChldmVudCkpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBvbkFycm93UHJlc3MoZmFsc2UpO1xuICAgIH0gZWxzZSBpZiAoaXNFc2NFdmVudChldmVudCkpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBuZXh0VGljayhjbG9zZURyb3Bkb3duKTtcbiAgICB9XG4gIH07XG59XG5cbnR5cGUgT25LZXlkb3duID0gUmV0dXJuVHlwZTx0eXBlb2YgZ2V0T25LZXlkb3duPjtcblxuZnVuY3Rpb24gZ2V0R2VuZXJhdGVJdGVtPFQ+KFxuICBpdGVtc1JlZjogUmVmPEhUTUxFbGVtZW50W10+LFxuICBsZW5ndGg6IFJlZjxudW1iZXI+LFxuICBvbktleWRvd246IE9uS2V5ZG93bixcbiAgc2V0U2VsZWN0ZWQ6IFNldFNlbGVjdGVkPFQ+LFxuICBzZXRIb3ZlcmVkOiBTZXRIb3ZlcmVkPFQ+LFxuICBzbG90czogU2xvdHNcbikge1xuICByZXR1cm4gZnVuY3Rpb24gZ2VuZXJhdGVJdGVtKGl0ZW06IEF1dG9jb21wbGV0ZUl0ZW08VD4sIGluZGV4OiBudW1iZXIpOiBWTm9kZSB7XG4gICAgcmV0dXJuIGgoXG4gICAgICBCRHJvcGRvd25JdGVtLFxuICAgICAge1xuICAgICAgICBrZXk6IGl0ZW0uaWQsXG4gICAgICAgIHJlZjogKGVsOiBhbnkpID0+IHtcbiAgICAgICAgICBpdGVtc1JlZi52YWx1ZVtpbmRleF0gPSBlbDtcbiAgICAgICAgfSxcbiAgICAgICAgaWQ6IGl0ZW0uaWQsXG4gICAgICAgIGlzQWN0aXZlOiBpdGVtLmlzU2VsZWN0ZWQsXG4gICAgICAgIHRhYmluZGV4OiBpdGVtLmlzU2VsZWN0ZWQgPyAtMSA6IDAsXG4gICAgICAgICdhcmlhLXNlbGVjdGVkJzogaXRlbS5pc1NlbGVjdGVkLFxuICAgICAgICAnYXJpYS1sYWJlbCc6IGBPcHRpb24gJHtpbmRleCArIDF9IG9mICR7bGVuZ3RoLnZhbHVlfWAsXG4gICAgICAgIGNsYXNzOiB7ICdpcy1ob3ZlcmVkJzogaXRlbS5pc0hvdmVyZWQgfSxcbiAgICAgICAgb25DbGljazogKCkgPT4gc2V0U2VsZWN0ZWQoaXRlbSksXG4gICAgICAgIG9uTW91c2VlbnRlcjogKCkgPT4gc2V0SG92ZXJlZChpdGVtKSxcbiAgICAgICAgb25LZXlkb3duXG4gICAgICB9LFxuICAgICAgKCkgPT4gKHNsb3RzLmRlZmF1bHQgPyBzbG90cy5kZWZhdWx0KHsgb3B0aW9uOiBpdGVtLCBpbmRleCB9KSA6IGl0ZW0udGV4dClcbiAgICApO1xuICB9O1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUhlYWRlckl0ZW0oc2xvdHM6IFNsb3RzKTogVk5vZGUge1xuICByZXR1cm4gaCgnbGknLCB7IHRhYmluZGV4OiAtMSB9LCBbaChCRHJvcGRvd25JdGVtLCB7IHRhZzogJ2RpdicgfSwgc2xvdHMuaGVhZGVyISgpKV0pO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUxvYWRpbmdJdGVtKHNsb3RzOiBTbG90cyk6IFZOb2RlIHtcbiAgcmV0dXJuIGgoJ2xpJywgeyB0YWJpbmRleDogLTEgfSwgW1xuICAgIGgoQkRyb3Bkb3duSXRlbSwgeyB0YWc6ICdkaXYnIH0sICgpID0+IChzbG90cy5sb2FkaW5nID8gc2xvdHMubG9hZGluZygpIDogJ0xvYWRpbmcgcmVzdWx0cy4uLicpKVxuICBdKTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVFbXB0eUl0ZW0obW9kZWxWYWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkLCBzbG90czogU2xvdHMpIHtcbiAgcmV0dXJuIGgoXG4gICAgQkRyb3Bkb3duSXRlbSxcbiAgICB7XG4gICAgICBjbGFzczogJ2lzLWRpc2FibGVkJ1xuICAgIH0sXG4gICAgKCkgPT4gKHNsb3RzLmVtcHR5ID8gc2xvdHMuZW1wdHkoKSA6IG1vZGVsVmFsdWUgPyBgTm8gcmVzdWx0c2AgOiBgTm8gcmVzdWx0cyBmb3IgJHttb2RlbFZhbHVlfWApXG4gICk7XG59XG5cbmZ1bmN0aW9uIGRlZmluZUF1dG9jb21wbGV0ZTxUPigpIHtcbiAgcmV0dXJuIGRlZmluZUNvbXBvbmVudCh7XG4gICAgbmFtZTogJ2ItYXV0b2NvbXBsZXRlJyxcbiAgICBwcm9wczoge1xuICAgICAgLi4uU3RhdGljVXNlSW5wdXRQcm9wcyxcbiAgICAgIC4uLmdldEVxUHJvcHNEZWZpbml0aW9uPFQ+KCksXG4gICAgICAuLi51c2VUaGVtZVByb3BzRGVmaW5pdGlvbihEcm9wZG93blRoZW1lTWFwKSxcbiAgICAgIC4uLmdldFVzZU1vZGVsUHJvcHNEZWZpbml0aW9uPHN0cmluZz4oKSxcbiAgICAgIC4uLmdldFVzZU1vZGVsUHJvcHNEZWZpbml0aW9uPFRbXSwgJ3NlbGVjdGVkSXRlbXMnLCAnb25VcGRhdGU6c2VsZWN0ZWRJdGVtcyc+KFxuICAgICAgICAnc2VsZWN0ZWRJdGVtcycsXG4gICAgICAgICdvblVwZGF0ZTpzZWxlY3RlZEl0ZW1zJ1xuICAgICAgKSxcbiAgICAgIHNlbGVjdGVkSXRlbXM6IHtcbiAgICAgICAgdHlwZTogQXJyYXkgYXMgUHJvcFR5cGU8VFtdPixcbiAgICAgICAgcmVxdWlyZWQ6IHRydWUgYXMgY29uc3RcbiAgICAgIH0sXG4gICAgICBpdGVtczoge1xuICAgICAgICB0eXBlOiBBcnJheSBhcyBQcm9wVHlwZTxUW10+LFxuICAgICAgICBkZWZhdWx0OiBjb25zdEVtcHR5QXJyYXlcbiAgICAgIH0sXG4gICAgICBpdGVtRmlsdGVyOiB7XG4gICAgICAgIHR5cGU6IEZ1bmN0aW9uIGFzIFByb3BUeXBlPEZ1bmN0aW9uTjxbc3RyaW5nXSwgUHJlZGljYXRlPFQ+Pj4sXG4gICAgICAgIHJlcXVpcmVkOiBmYWxzZVxuICAgICAgfSxcbiAgICAgIGl0ZW1JZDoge1xuICAgICAgICB0eXBlOiBbU3RyaW5nLCBGdW5jdGlvbl0gYXMgUHJvcFR5cGU8a2V5b2YgVCB8ICgoaXRlbTogVCkgPT4gc3RyaW5nKT4sXG4gICAgICAgIGRlZmF1bHQ6ICdpZCdcbiAgICAgIH0sXG4gICAgICBpdGVtVGV4dDoge1xuICAgICAgICB0eXBlOiBbU3RyaW5nLCBGdW5jdGlvbl0gYXMgUHJvcFR5cGU8a2V5b2YgVCB8ICgoaXRlbTogVCkgPT4gc3RyaW5nKT4sXG4gICAgICAgIGRlZmF1bHQ6ICd0ZXh0J1xuICAgICAgfSxcbiAgICAgIGNsb3NlT25TZWxlY3Q6IHtcbiAgICAgICAgdHlwZTogQm9vbGVhbiBhcyBQcm9wVHlwZTxib29sZWFuPixcbiAgICAgICAgZGVmYXVsdDogdHJ1ZVxuICAgICAgfSxcbiAgICAgIGNsZWFyT25TZWxlY3Q6IHtcbiAgICAgICAgdHlwZTogQm9vbGVhbiBhcyBQcm9wVHlwZTxib29sZWFuPixcbiAgICAgICAgZGVmYXVsdDogdHJ1ZVxuICAgICAgfSxcbiAgICAgIG9wZW5PbkZvY3VzOiB7XG4gICAgICAgIHR5cGU6IEJvb2xlYW4gYXMgUHJvcFR5cGU8Ym9vbGVhbj4sXG4gICAgICAgIGRlZmF1bHQ6IHRydWVcbiAgICAgIH0sXG4gICAgICBvblNlbGVjdGVkOiB7XG4gICAgICAgIHR5cGU6IEZ1bmN0aW9uIGFzIFByb3BUeXBlPEZ1bmN0aW9uTjxbVF0sIHZvaWQ+PixcbiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlXG4gICAgICB9XG4gICAgfSxcbiAgICBzZXR1cChwcm9wcywgeyBzbG90cyB9KSB7XG4gICAgICBjb25zdCB7IHZhbHVlOiBzZWFyY2hWYWx1ZSB9ID0gdXNlUHJveHkoXG4gICAgICAgIGNvbXB1dGVkKCgpID0+IHByb3BzLm1vZGVsVmFsdWUgPz8gJycpLFxuICAgICAgICB0b1JlZihwcm9wcywgJ29uVXBkYXRlOm1vZGVsVmFsdWUnKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IHsgdmFsdWU6IHNlbGVjdGVkSXRlbXMgfSA9IHVzZVByb3h5KHRvUmVmKHByb3BzLCAnc2VsZWN0ZWRJdGVtcycpLCB0b1JlZihwcm9wcywgJ29uVXBkYXRlOnNlbGVjdGVkSXRlbXMnKSk7XG5cbiAgICAgIGNvbnN0IGl0ZW1zUmVmID0gc2hhbGxvd1JlZihbXSBhcyBIVE1MRWxlbWVudFtdKTtcbiAgICAgIGNvbnN0IGZpbHRlcmVkSXRlbXMgPSBjb21wdXRlZCgoKSA9PlxuICAgICAgICBwcm9wcy5pdGVtRmlsdGVyID8gcHJvcHMuaXRlbXMuZmlsdGVyKHByb3BzLml0ZW1GaWx0ZXIoc2VhcmNoVmFsdWUudmFsdWUpKSA6IHByb3BzLml0ZW1zXG4gICAgICApO1xuICAgICAgb25CZWZvcmVVcGRhdGUoKCkgPT4gKGl0ZW1zUmVmLnZhbHVlID0gW10pKTtcbiAgICAgIGNvbnN0IGRyb3Bkb3duOiBSZWY8SW5zdGFuY2VUeXBlPHR5cGVvZiBCRHJvcGRvd24+IHwgbnVsbD4gPSBzaGFsbG93UmVmKG51bGwpO1xuICAgICAgZnVuY3Rpb24gY2xvc2UoKSB7XG4gICAgICAgIGRyb3Bkb3duLnZhbHVlICYmIGRyb3Bkb3duLnZhbHVlLnRvZ2dsZS5zZXRPZmYoKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGhvdmVyZWRJdGVtID0gc2hhbGxvd1JlZihub25lIGFzIE9wdGlvbjxBdXRvY29tcGxldGVJdGVtPFQ+Pik7XG4gICAgICBjb25zdCBhY3RpdmVEZXNjZW5kZW50SWQgPSBjb21wdXRlZCgoKSA9PiBnZXRBY3RpdmVEZXNjZW5kZW50SWQocHJvcHMuc2VsZWN0ZWRJdGVtcywgcHJvcHMuaXRlbUlkIGFzIGFueSkpO1xuICAgICAgY29uc3QgYXV0b2NvbXBsZXRlSXRlbXMgPSBjb21wdXRlZCgoKSA9PlxuICAgICAgICBnZXRBdXRvY29tcGxldGVJdGVtcyhcbiAgICAgICAgICBmaWx0ZXJlZEl0ZW1zLnZhbHVlLFxuICAgICAgICAgIHNlbGVjdGVkSXRlbXMudmFsdWUsXG4gICAgICAgICAgcHJvcHMuaXRlbUlkIGFzIGFueSxcbiAgICAgICAgICBwcm9wcy5pdGVtVGV4dCBhcyBhbnksXG4gICAgICAgICAgcHJvcHMuZXEsXG4gICAgICAgICAgaG92ZXJlZEl0ZW0udmFsdWVcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IG51bWJlck9mSXRlbXMgPSBjb21wdXRlZCgoKSA9PiBhdXRvY29tcGxldGVJdGVtcy52YWx1ZS5sZW5ndGgpO1xuICAgICAgY29uc3Qgc2V0U2VsZWN0ZWQgPSBnZXRTZXRTZWxlY3RlZChwcm9wcywgY2xvc2UsIHNlYXJjaFZhbHVlLCBzZWxlY3RlZEl0ZW1zKTtcbiAgICAgIGNvbnN0IHNldEhvdmVyZWQgPSBnZXRTZXRIb3ZlcmVkKGhvdmVyZWRJdGVtLCBpdGVtc1JlZik7XG4gICAgICBjb25zdCBvbktleWRvd24gPSBnZXRPbktleWRvd24oYXV0b2NvbXBsZXRlSXRlbXMsIGhvdmVyZWRJdGVtLCBjbG9zZSwgc2V0U2VsZWN0ZWQsIHNldEhvdmVyZWQpO1xuICAgICAgY29uc3QgZ2VuZXJhdGVJdGVtID0gZ2V0R2VuZXJhdGVJdGVtKGl0ZW1zUmVmLCBudW1iZXJPZkl0ZW1zLCBvbktleWRvd24sIHNldFNlbGVjdGVkLCBzZXRIb3ZlcmVkLCBzbG90cyk7XG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICByZXR1cm4gaChcbiAgICAgICAgICBCRHJvcGRvd24sXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVmOiBkcm9wZG93bixcbiAgICAgICAgICAgIGlzTW9iaWxlTW9kYWw6IGZhbHNlLFxuICAgICAgICAgICAgY2xhc3M6IFsnYi1hdXRvY29tcGxldGUnLCB7ICdpcy1leHBhbmRlZCc6IHByb3BzLmlzRXhwYW5kZWQgfV1cbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHRyaWdnZXI6ICgpID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIGgoQklucHV0LCB7XG4gICAgICAgICAgICAgICAgbW9kZWxWYWx1ZTogc2VhcmNoVmFsdWUudmFsdWUsXG4gICAgICAgICAgICAgICAgdHlwZTogJ3RleHQnLFxuICAgICAgICAgICAgICAgIHNpemU6IHByb3BzLnNpemUsXG4gICAgICAgICAgICAgICAgaXNMb2FkaW5nOiBwcm9wcy5pc0xvYWRpbmcsXG4gICAgICAgICAgICAgICAgaXNSb3VuZGVkOiBwcm9wcy5pc1JvdW5kZWQsXG4gICAgICAgICAgICAgICAgaWNvbjogcHJvcHMuaWNvbixcbiAgICAgICAgICAgICAgICBtYXhsZW5ndGg6IHByb3BzLm1heGxlbmd0aCxcbiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGU6IHByb3BzLmF1dG9jb21wbGV0ZSB8fCAnbGlzdCcsXG4gICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6IHByb3BzLnBsYWNlaG9sZGVyLFxuICAgICAgICAgICAgICAgIHJvbGU6ICdzZWFyY2hib3gnLFxuICAgICAgICAgICAgICAgICdhcmlhLWFjdGl2ZWRlc2NlbmRhbnQnOiBhY3RpdmVEZXNjZW5kZW50SWQudmFsdWUsXG4gICAgICAgICAgICAgICAgJ29uVXBkYXRlOm1vZGVsVmFsdWUnOiAodmFsOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgIHNlYXJjaFZhbHVlLnZhbHVlID0gdmFsO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb25Gb2N1czogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKHByb3BzLm9wZW5PbkZvY3VzKSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkID0gZHJvcGRvd24udmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKGQgJiYgZC50b2dnbGUuaXNPZmYudmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGQudG9nZ2xlLnNldE9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9uQmx1cjogcHJvcHMub25CbHVyLFxuICAgICAgICAgICAgICAgIG9uS2V5ZG93blxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkZWZhdWx0OiAoKSA9PiB7XG4gICAgICAgICAgICAgIGxldCBub2RlczogVk5vZGVbXTtcbiAgICAgICAgICAgICAgaWYgKHByb3BzLmlzTG9hZGluZykge1xuICAgICAgICAgICAgICAgIG5vZGVzID0gW2dlbmVyYXRlTG9hZGluZ0l0ZW0oc2xvdHMpXTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBub2RlcyA9IGlzRW1wdHkoYXV0b2NvbXBsZXRlSXRlbXMudmFsdWUpXG4gICAgICAgICAgICAgICAgICA/IFtnZW5lcmF0ZUVtcHR5SXRlbShzZWFyY2hWYWx1ZS52YWx1ZSwgc2xvdHMpXVxuICAgICAgICAgICAgICAgICAgOiBhdXRvY29tcGxldGVJdGVtcy52YWx1ZS5tYXAoZ2VuZXJhdGVJdGVtKTtcbiAgICAgICAgICAgICAgICBpZiAoc2xvdHMuaGVhZGVyKSB7XG4gICAgICAgICAgICAgICAgICBub2Rlcy51bnNoaWZ0KGdlbmVyYXRlSGVhZGVySXRlbShzbG90cyksIGgoQkRyb3Bkb3duRGl2aWRlcikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXR1cm4gbm9kZXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgY29uc3QgQkF1dG9jb21wbGV0ZSA9IGRlZmluZUF1dG9jb21wbGV0ZTxhbnk+KCk7XG4iXX0=