import './tabs.sass';
import { getUseModelPropsDefinition, useModel } from '../../composables/model';
import { useThemePropsDefinition, useTheme } from '../../composables/theme';
import { isFragment, isObject } from '../../utils/helpers';
import BScroll from '../scroll/BScroll';
import { h, shallowRef, provide, nextTick, Transition, defineComponent, onBeforeMount } from 'vue';
import { none, some } from 'fp-ts/lib/Option';
import { TAB_ITEM_NAME, TABS_SYMBOL } from './shared';
import { TabsThemeMap } from './theme';
export const BTabsPropsDefinition = {
    ...getUseModelPropsDefinition(),
    ...useThemePropsDefinition(TabsThemeMap),
    isExpanded: {
        type: Boolean,
        default: false
    },
    type: {
        type: String,
        default: ''
    },
    size: {
        type: String,
        default: ''
    },
    position: {
        type: String,
        default: ''
    },
    label: {
        type: String
    },
    variant: {
        type: String,
        default: ''
    },
    isAnimated: {
        type: Boolean,
        default: true
    },
    isScrollable: {
        type: Boolean,
        default: false
    }
};
function useOnTabItemClick(tab, index, model, activeLabel, transition) {
    return () => {
        const val = model.modelValue.value || 0;
        if (val !== index) {
            transition.value = index < val ? 'slide-next' : 'slide-prev';
            nextTick(() => {
                model.set(index);
                activeLabel.value = some(tab.props.label);
            });
        }
    };
}
function useGenerateNavItem(props, model, activeLabel, transition) {
    return function generateNavItem(step, index) {
        return h('li', {
            key: step.props.label,
            class: [
                {
                    'is-active': index === model.modelValue.value,
                    'is-disabled': step.props.isDisabled
                }
            ]
        }, [
            h('a', { onClick: useOnTabItemClick(step, index, model, activeLabel, transition) }, step.props.icon
                ? [
                    h(step.props.icon, {
                        size: props.size
                    }),
                    step.props.label
                ]
                : step.props.label)
        ]);
    };
}
function generateNavLabel(props) {
    return h('label', {
        class: ['label is-marginless align-self-center', props.size]
    }, props.label);
}
function generateNavItems(props, tabs, model, activeLabel, transition) {
    return h('ul', tabs.map(useGenerateNavItem(props, model, activeLabel, transition)));
}
function generateNavHeaderContent(props, tabs, model, activeLabel, transition, themeClasses) {
    return h('nav', {
        class: [
            'tabs',
            props.type,
            props.size,
            props.position,
            {
                'is-fullwidth': !!props.isExpanded || !!props.isScrollable,
                'is-toggle-rounded is-toggle': props.type === 'is-toggle-rounded'
            }
        ].concat(props.variant === '' ? themeClasses : [props.variant])
    }, props.label
        ? [generateNavLabel(props), generateNavItems(props, tabs, model, activeLabel, transition)]
        : [generateNavItems(props, tabs, model, activeLabel, transition)]);
}
function generateNavHeader(props, tabs, model, activeLabel, transition, themeClasses) {
    return props.isScrollable
        ? h(BScroll, { class: 'is-fullwidth' }, () => [
            generateNavHeaderContent(props, tabs, model, activeLabel, transition, themeClasses)
        ])
        : generateNavHeaderContent(props, tabs, model, activeLabel, transition, themeClasses);
}
function generateTabContent(props, tabs, model, transition) {
    return props.isAnimated
        ? h(Transition, { name: transition.value }, () => tabs[model.modelValue.value || 0])
        : tabs[model.modelValue.value || 0];
}
function isBTabItemNode(node) {
    return (isObject(node) &&
        isObject(node.type) &&
        node.type.name === TAB_ITEM_NAME &&
        (node.props['is-visible'] === undefined ||
            node.props['is-visible'] ||
            node.props.isVisible === undefined ||
            node.props.isVisible));
}
function getTabs(slots) {
    return (((slots.default && slots.default()) ||
        []).flatMap(node => (isFragment(node) ? node.children : [node])).filter(isBTabItemNode));
}
export default defineComponent({
    name: 'b-tabs',
    props: BTabsPropsDefinition,
    setup(props, context) {
        const { themeClasses } = useTheme(props);
        const model = useModel(props);
        const transition = shallowRef('slide-next');
        const injection = {
            activeLabel: shallowRef(none)
        };
        provide(TABS_SYMBOL, injection);
        onBeforeMount(() => {
            if (model.modelValue.value === undefined) {
                model.set(0);
            }
        });
        return () => {
            const tabs = getTabs(context.slots);
            return h('article', { class: 'b-tabs' }, [
                generateNavHeader(props, tabs, model, injection.activeLabel, transition, themeClasses.value),
                generateTabContent(props, tabs, model, transition)
            ]);
        };
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQlRhYnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9uZW50cy90YWJzL0JUYWJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSwwQkFBMEIsRUFBUyxRQUFRLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN0RixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsUUFBUSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFNUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzRCxPQUFPLE9BQU8sTUFBTSxtQkFBbUIsQ0FBQztBQUN4QyxPQUFPLEVBRUwsQ0FBQyxFQUNELFVBQVUsRUFDVixPQUFPLEVBR1AsUUFBUSxFQUNSLFVBQVUsRUFDVixlQUFlLEVBR2YsYUFBYSxFQUNkLE1BQU0sS0FBSyxDQUFDO0FBQ2IsT0FBTyxFQUFFLElBQUksRUFBVSxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN0RCxPQUFPLEVBQStCLGFBQWEsRUFBZ0IsV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFVdkMsTUFBTSxDQUFDLE1BQU0sb0JBQW9CLEdBQUc7SUFDbEMsR0FBRywwQkFBMEIsRUFBVTtJQUN2QyxHQUFHLHVCQUF1QixDQUFDLFlBQVksQ0FBQztJQUN4QyxVQUFVLEVBQUU7UUFDVixJQUFJLEVBQUUsT0FBNEI7UUFDbEMsT0FBTyxFQUFFLEtBQUs7S0FDZjtJQUNELElBQUksRUFBRTtRQUNKLElBQUksRUFBRSxNQUEyQjtRQUNqQyxPQUFPLEVBQUUsRUFBVztLQUNyQjtJQUNELElBQUksRUFBRTtRQUNKLElBQUksRUFBRSxNQUEyQjtRQUNqQyxPQUFPLEVBQUUsRUFBVztLQUNyQjtJQUNELFFBQVEsRUFBRTtRQUNSLElBQUksRUFBRSxNQUErQjtR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Q0FBQyxLQUFLLENBQUM7Z0JBQzVGLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFVBQVUsQ0FBQzthQUNuRCxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICcuL3RhYnMuc2Fzcyc7XG5pbXBvcnQgeyBnZXRVc2VNb2RlbFByb3BzRGVmaW5pdGlvbiwgTW9kZWwsIHVzZU1vZGVsIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvbW9kZWwnO1xuaW1wb3J0IHsgdXNlVGhlbWVQcm9wc0RlZmluaXRpb24sIHVzZVRoZW1lIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdGhlbWUnO1xuaW1wb3J0IHsgQWxsQ29sb3JzVmFyaWFudCB9IGZyb20gJy4uLy4uL3R5cGVzL0NvbG9yVmFyaWFudHMnO1xuaW1wb3J0IHsgaXNGcmFnbWVudCwgaXNPYmplY3QgfSBmcm9tICcuLi8uLi91dGlscy9oZWxwZXJzJztcbmltcG9ydCBCU2Nyb2xsIGZyb20gJy4uL3Njcm9sbC9CU2Nyb2xsJztcbmltcG9ydCB7XG4gIFByb3BUeXBlLFxuICBoLFxuICBzaGFsbG93UmVmLFxuICBwcm92aWRlLFxuICBFeHRyYWN0UHJvcFR5cGVzLFxuICBSZWYsXG4gIG5leHRUaWNrLFxuICBUcmFuc2l0aW9uLFxuICBkZWZpbmVDb21wb25lbnQsXG4gIFZOb2RlLFxuICBTbG90cyxcbiAgb25CZWZvcmVNb3VudFxufSBmcm9tICd2dWUnO1xuaW1wb3J0IHsgbm9uZSwgT3B0aW9uLCBzb21lIH0gZnJvbSAnZnAtdHMvbGliL09wdGlvbic7XG5pbXBvcnQgeyBCVGFiSXRlbURhdGEsIEJUYWJJdGVtUHJvcHMsIFRBQl9JVEVNX05BTUUsIFRhYkluamVjdGlvbiwgVEFCU19TWU1CT0wgfSBmcm9tICcuL3NoYXJlZCc7XG5pbXBvcnQgeyBUYWJzVGhlbWVNYXAgfSBmcm9tICcuL3RoZW1lJztcblxuZXhwb3J0IHR5cGUgVGFiUG9zaXRpb24gPSAnaXMtY2VudGVyZWQnIHwgJ2lzLXJpZ2h0JyB8ICcnO1xuXG5leHBvcnQgdHlwZSBUYWJUeXBlID0gJ2lzLWJveGVkJyB8ICdpcy10b2dnbGUnIHwgJ2lzLXRvZ2dsZS1yb3VuZGVkJyB8ICcnO1xuXG5leHBvcnQgdHlwZSBUYWJTaXplID0gJ2lzLXNtYWxsJyB8ICdpcy1tZWRpdW0nIHwgJ2lzLWxhcmdlJyB8ICcnO1xuXG50eXBlIFRhYlRyYW5zaXRpb24gPSAnc2xpZGUtbmV4dCcgfCAnc2xpZGUtcHJldic7XG5cbmV4cG9ydCBjb25zdCBCVGFic1Byb3BzRGVmaW5pdGlvbiA9IHtcbiAgLi4uZ2V0VXNlTW9kZWxQcm9wc0RlZmluaXRpb248bnVtYmVyPigpLFxuICAuLi51c2VUaGVtZVByb3BzRGVmaW5pdGlvbihUYWJzVGhlbWVNYXApLFxuICBpc0V4cGFuZGVkOiB7XG4gICAgdHlwZTogQm9vbGVhbiBhcyBQcm9wVHlwZTxib29sZWFuPixcbiAgICBkZWZhdWx0OiBmYWxzZVxuICB9LFxuICB0eXBlOiB7XG4gICAgdHlwZTogU3RyaW5nIGFzIFByb3BUeXBlPFRhYlR5cGU+LFxuICAgIGRlZmF1bHQ6ICcnIGFzIGNvbnN0XG4gIH0sXG4gIHNpemU6IHtcbiAgICB0eXBlOiBTdHJpbmcgYXMgUHJvcFR5cGU8VGFiU2l6ZT4sXG4gICAgZGVmYXVsdDogJycgYXMgY29uc3RcbiAgfSxcbiAgcG9zaXRpb246IHtcbiAgICB0eXBlOiBTdHJpbmcgYXMgUHJvcFR5cGU8VGFiUG9zaXRpb24+LFxuICAgIGRlZmF1bHQ6ICcnIGFzIGNvbnN0XG4gIH0sXG4gIGxhYmVsOiB7XG4gICAgdHlwZTogU3RyaW5nIGFzIFByb3BUeXBlPHN0cmluZz5cbiAgfSxcbiAgdmFyaWFudDoge1xuICAgIHR5cGU6IFN0cmluZyBhcyBQcm9wVHlwZTxBbGxDb2xvcnNWYXJpYW50PixcbiAgICBkZWZhdWx0OiAnJyBhcyBjb25zdFxuICB9LFxuICBpc0FuaW1hdGVkOiB7XG4gICAgdHlwZTogQm9vbGVhbiBhcyBQcm9wVHlwZTxib29sZWFuPixcbiAgICBkZWZhdWx0OiB0cnVlXG4gIH0sXG4gIGlzU2Nyb2xsYWJsZToge1xuICAgIHR5cGU6IEJvb2xlYW4gYXMgUHJvcFR5cGU8Ym9vbGVhbj4sXG4gICAgZGVmYXVsdDogZmFsc2VcbiAgfVxufTtcblxuZXhwb3J0IHR5cGUgQlRhYnNQcm9wcyA9IEV4dHJhY3RQcm9wVHlwZXM8dHlwZW9mIEJUYWJzUHJvcHNEZWZpbml0aW9uPjtcblxuZnVuY3Rpb24gdXNlT25UYWJJdGVtQ2xpY2soXG4gIHRhYjogQlRhYkl0ZW1EYXRhLFxuICBpbmRleDogbnVtYmVyLFxuICBtb2RlbDogTW9kZWw8bnVtYmVyPixcbiAgYWN0aXZlTGFiZWw6IFJlZjxPcHRpb248c3RyaW5nPj4sXG4gIHRyYW5zaXRpb246IFJlZjxUYWJUcmFuc2l0aW9uPlxuKSB7XG4gIHJldHVybiAoKSA9PiB7XG4gICAgY29uc3QgdmFsID0gbW9kZWwubW9kZWxWYWx1ZS52YWx1ZSB8fCAwO1xuICAgIGlmICh2YWwgIT09IGluZGV4KSB7XG4gICAgICB0cmFuc2l0aW9uLnZhbHVlID0gaW5kZXggPCB2YWwgPyAnc2xpZGUtbmV4dCcgOiAnc2xpZGUtcHJldic7XG4gICAgICBuZXh0VGljaygoKSA9PiB7XG4gICAgICAgIG1vZGVsLnNldChpbmRleCk7XG4gICAgICAgIGFjdGl2ZUxhYmVsLnZhbHVlID0gc29tZSh0YWIucHJvcHMubGFiZWwpO1xuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VHZW5lcmF0ZU5hdkl0ZW0oXG4gIHByb3BzOiBCVGFic1Byb3BzLFxuICBtb2RlbDogTW9kZWw8bnVtYmVyPixcbiAgYWN0aXZlTGFiZWw6IFJlZjxPcHRpb248c3RyaW5nPj4sXG4gIHRyYW5zaXRpb246IFJlZjxUYWJUcmFuc2l0aW9uPlxuKSB7XG4gIHJldHVybiBmdW5jdGlvbiBnZW5lcmF0ZU5hdkl0ZW0oc3RlcDogQlRhYkl0ZW1EYXRhLCBpbmRleDogbnVtYmVyKTogVk5vZGUge1xuICAgIHJldHVybiBoKFxuICAgICAgJ2xpJyxcbiAgICAgIHtcbiAgICAgICAga2V5OiBzdGVwLnByb3BzLmxhYmVsLFxuICAgICAgICBjbGFzczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgICdpcy1hY3RpdmUnOiBpbmRleCA9PT0gbW9kZWwubW9kZWxWYWx1ZS52YWx1ZSxcbiAgICAgICAgICAgICdpcy1kaXNhYmxlZCc6IHN0ZXAucHJvcHMuaXNEaXNhYmxlZFxuICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgICAgfSxcbiAgICAgIFtcbiAgICAgICAgaChcbiAgICAgICAgICAnYScsXG4gICAgICAgICAgeyBvbkNsaWNrOiB1c2VPblRhYkl0ZW1DbGljayhzdGVwLCBpbmRleCwgbW9kZWwsIGFjdGl2ZUxhYmVsLCB0cmFuc2l0aW9uKSB9LFxuICAgICAgICAgIHN0ZXAucHJvcHMuaWNvblxuICAgICAgICAgICAgPyBbXG4gICAgICAgICAgICAgICAgaChzdGVwLnByb3BzLmljb24gYXMgYW55LCB7XG4gICAgICAgICAgICAgICAgICBzaXplOiBwcm9wcy5zaXplXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgc3RlcC5wcm9wcy5sYWJlbFxuICAgICAgICAgICAgICBdXG4gICAgICAgICAgICA6IHN0ZXAucHJvcHMubGFiZWxcbiAgICAgICAgKVxuICAgICAgXVxuICAgICk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlTmF2TGFiZWwocHJvcHM6IEJUYWJzUHJvcHMpOiBWTm9kZSB7XG4gIHJldHVybiBoKFxuICAgICdsYWJlbCcsXG4gICAge1xuICAgICAgY2xhc3M6IFsnbGFiZWwgaXMtbWFyZ2lubGVzcyBhbGlnbi1zZWxmLWNlbnRlcicsIHByb3BzLnNpemVdXG4gICAgfSxcbiAgICBwcm9wcy5sYWJlbFxuICApO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZU5hdkl0ZW1zKFxuICBwcm9wczogQlRhYnNQcm9wcyxcbiAgdGFiczogQlRhYkl0ZW1EYXRhW10sXG4gIG1vZGVsOiBNb2RlbDxudW1iZXI+LFxuICBhY3RpdmVMYWJlbDogUmVmPE9wdGlvbjxzdHJpbmc+PixcbiAgdHJhbnNpdGlvbjogUmVmPFRhYlRyYW5zaXRpb24+XG4pIHtcbiAgcmV0dXJuIGgoJ3VsJywgdGFicy5tYXAodXNlR2VuZXJhdGVOYXZJdGVtKHByb3BzLCBtb2RlbCwgYWN0aXZlTGFiZWwsIHRyYW5zaXRpb24pKSk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlTmF2SGVhZGVyQ29udGVudChcbiAgcHJvcHM6IEJUYWJzUHJvcHMsXG4gIHRhYnM6IEJUYWJJdGVtRGF0YVtdLFxuICBtb2RlbDogTW9kZWw8bnVtYmVyPixcbiAgYWN0aXZlTGFiZWw6IFJlZjxPcHRpb248c3RyaW5nPj4sXG4gIHRyYW5zaXRpb246IFJlZjxUYWJUcmFuc2l0aW9uPixcbiAgdGhlbWVDbGFzc2VzOiBzdHJpbmdbXVxuKTogVk5vZGUge1xuICByZXR1cm4gaChcbiAgICAnbmF2JyxcbiAgICB7XG4gICAgICBjbGFzczogW1xuICAgICAgICAndGFicycsXG4gICAgICAgIHByb3BzLnR5cGUsXG4gICAgICAgIHByb3BzLnNpemUsXG4gICAgICAgIHByb3BzLnBvc2l0aW9uLFxuICAgICAgICB7XG4gICAgICAgICAgJ2lzLWZ1bGx3aWR0aCc6ICEhcHJvcHMuaXNFeHBhbmRlZCB8fCAhIXByb3BzLmlzU2Nyb2xsYWJsZSxcbiAgICAgICAgICAnaXMtdG9nZ2xlLXJvdW5kZWQgaXMtdG9nZ2xlJzogcHJvcHMudHlwZSA9PT0gJ2lzLXRvZ2dsZS1yb3VuZGVkJ1xuICAgICAgICB9XG4gICAgICBdLmNvbmNhdChwcm9wcy52YXJpYW50ID09PSAnJyA/IHRoZW1lQ2xhc3NlcyA6IFtwcm9wcy52YXJpYW50XSlcbiAgICB9LFxuICAgIHByb3BzLmxhYmVsXG4gICAgICA/IFtnZW5lcmF0ZU5hdkxhYmVsKHByb3BzKSwgZ2VuZXJhdGVOYXZJdGVtcyhwcm9wcywgdGFicywgbW9kZWwsIGFjdGl2ZUxhYmVsLCB0cmFuc2l0aW9uKV1cbiAgICAgIDogW2dlbmVyYXRlTmF2SXRlbXMocHJvcHMsIHRhYnMsIG1vZGVsLCBhY3RpdmVMYWJlbCwgdHJhbnNpdGlvbildXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlTmF2SGVhZGVyKFxuICBwcm9wczogQlRhYnNQcm9wcyxcbiAgdGFiczogQlRhYkl0ZW1Ob2RlW10sXG4gIG1vZGVsOiBNb2RlbDxudW1iZXI+LFxuICBhY3RpdmVMYWJlbDogUmVmPE9wdGlvbjxzdHJpbmc+PixcbiAgdHJhbnNpdGlvbjogUmVmPFRhYlRyYW5zaXRpb24+LFxuICB0aGVtZUNsYXNzZXM6IHN0cmluZ1tdXG4pOiBWTm9kZSB7XG4gIHJldHVybiBwcm9wcy5pc1Njcm9sbGFibGVcbiAgICA/IGgoQlNjcm9sbCwgeyBjbGFzczogJ2lzLWZ1bGx3aWR0aCcgfSwgKCkgPT4gW1xuICAgICAgICBnZW5lcmF0ZU5hdkhlYWRlckNvbnRlbnQocHJvcHMsIHRhYnMsIG1vZGVsLCBhY3RpdmVMYWJlbCwgdHJhbnNpdGlvbiwgdGhlbWVDbGFzc2VzKVxuICAgICAgXSlcbiAgICA6IGdlbmVyYXRlTmF2SGVhZGVyQ29udGVudChwcm9wcywgdGFicywgbW9kZWwsIGFjdGl2ZUxhYmVsLCB0cmFuc2l0aW9uLCB0aGVtZUNsYXNzZXMpO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVRhYkNvbnRlbnQoXG4gIHByb3BzOiBCVGFic1Byb3BzLFxuICB0YWJzOiBCVGFiSXRlbU5vZGVbXSxcbiAgbW9kZWw6IE1vZGVsPG51bWJlcj4sXG4gIHRyYW5zaXRpb246IFJlZjxUYWJUcmFuc2l0aW9uPlxuKTogVk5vZGUge1xuICByZXR1cm4gcHJvcHMuaXNBbmltYXRlZFxuICAgID8gaChUcmFuc2l0aW9uLCB7IG5hbWU6IHRyYW5zaXRpb24udmFsdWUgfSwgKCkgPT4gdGFic1ttb2RlbC5tb2RlbFZhbHVlLnZhbHVlIHx8IDBdKVxuICAgIDogdGFic1ttb2RlbC5tb2RlbFZhbHVlLnZhbHVlIHx8IDBdO1xufVxuXG5pbnRlcmZhY2UgQlRhYkl0ZW1Ob2RlIGV4dGVuZHMgVk5vZGUge1xuICB0eXBlOiB7XG4gICAgbmFtZTogdHlwZW9mIFRBQl9JVEVNX05BTUU7XG4gIH07XG4gIHByb3BzOiBCVGFiSXRlbVByb3BzO1xufVxuXG5mdW5jdGlvbiBpc0JUYWJJdGVtTm9kZShub2RlOiB1bmtub3duKTogbm9kZSBpcyBCVGFiSXRlbU5vZGUge1xuICByZXR1cm4gKFxuICAgIGlzT2JqZWN0KG5vZGUpICYmXG4gICAgaXNPYmplY3QoKG5vZGUgYXMgYW55KS50eXBlKSAmJlxuICAgIChub2RlIGFzIGFueSkudHlwZS5uYW1lID09PSBUQUJfSVRFTV9OQU1FICYmXG4gICAgKChub2RlIGFzIGFueSkucHJvcHNbJ2lzLXZpc2libGUnXSA9PT0gdW5kZWZpbmVkIHx8XG4gICAgICAobm9kZSBhcyBhbnkpLnByb3BzWydpcy12aXNpYmxlJ10gfHxcbiAgICAgIChub2RlIGFzIGFueSkucHJvcHMuaXNWaXNpYmxlID09PSB1bmRlZmluZWQgfHxcbiAgICAgIChub2RlIGFzIGFueSkucHJvcHMuaXNWaXNpYmxlKVxuICApO1xufVxuXG5mdW5jdGlvbiBnZXRUYWJzKHNsb3RzOiBTbG90cyk6IGFueVtdIHtcbiAgcmV0dXJuIChcbiAgICAgICgoc2xvdHMuZGVmYXVsdCAmJiBzbG90cy5kZWZhdWx0KCkpIHx8XG4gICAgW10pLmZsYXRNYXAobm9kZSA9PiAoaXNGcmFnbWVudChub2RlKSA/IG5vZGUuY2hpbGRyZW4gOiBbbm9kZV0pKS5maWx0ZXIoaXNCVGFiSXRlbU5vZGUpXG4gICk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICdiLXRhYnMnLFxuICBwcm9wczogQlRhYnNQcm9wc0RlZmluaXRpb24sXG4gIHNldHVwKHByb3BzLCBjb250ZXh0KSB7XG4gICAgY29uc3QgeyB0aGVtZUNsYXNzZXMgfSA9IHVzZVRoZW1lKHByb3BzKTtcbiAgICBjb25zdCBtb2RlbCA9IHVzZU1vZGVsKHByb3BzKTtcbiAgICBjb25zdCB0cmFuc2l0aW9uID0gc2hhbGxvd1JlZignc2xpZGUtbmV4dCcgYXMgJ3NsaWRlLW5leHQnIHwgJ3NsaWRlLXByZXYnKTtcbiAgICBjb25zdCBpbmplY3Rpb246IFRhYkluamVjdGlvbiA9IHtcbiAgICAgIGFjdGl2ZUxhYmVsOiBzaGFsbG93UmVmKG5vbmUpXG4gICAgfTtcblxuICAgIHByb3ZpZGUoVEFCU19TWU1CT0wsIGluamVjdGlvbik7XG5cbiAgICBvbkJlZm9yZU1vdW50KCgpID0+IHtcbiAgICAgIGlmIChtb2RlbC5tb2RlbFZhbHVlLnZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbW9kZWwuc2V0KDApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHRhYnMgPSBnZXRUYWJzKGNvbnRleHQuc2xvdHMpO1xuICAgICAgcmV0dXJuIGgoJ2FydGljbGUnLCB7IGNsYXNzOiAnYi10YWJzJyB9LCBbXG4gICAgICAgIGdlbmVyYXRlTmF2SGVhZGVyKHByb3BzLCB0YWJzLCBtb2RlbCwgaW5qZWN0aW9uLmFjdGl2ZUxhYmVsLCB0cmFuc2l0aW9uLCB0aGVtZUNsYXNzZXMudmFsdWUpLFxuICAgICAgICBnZW5lcmF0ZVRhYkNvbnRlbnQocHJvcHMsIHRhYnMsIG1vZGVsLCB0cmFuc2l0aW9uKVxuICAgICAgXSk7XG4gICAgfTtcbiAgfVxufSk7XG4iXX0=